<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SA Schools</title>
    <link href="https://fonts.googleapis.com/css?family=Merriweather:700|Roboto+Condensed:300,400,700" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css">

    <script src="../lib/d3v4/d3.min.js"></script>
    <script src="../lib/jquery-3.2.1.min.js"></script>
    <script src="../lib/utilityfunctions.js"></script>
    <script src="function.js"></script>
    <script src="../lib/waypoints/jquery.waypoints.min.js"></script>
    <script src="../lib/waypoints/shortcuts/sticky.min.js"></script>


</head>

<body>






    <div id="text"></div>

    <div id="slides">

        <div id="slide-one" class="slide">
            <div class="passmark">
                <a href="http://passmark.org.za">Passmark
                    <i class="fa fa-check-square-o" aria-hidden="true"></i>
                </a>
            </div>
            <div class="slide-title">Education for a lifetime</div>



            <p>In January every year millions of children enter grade one, the start of an expected 12 years of primary and
                secondary schooling. In an ideal world the majority of these children will emerge with a matric certificate
                12 years later. Unfortunately this is far from the reality in South Africa's school system.</p>
<a id="link">Next</a>
        </div>

        <div id="slide-two" class="slide">
            <div class="slide-inner">
                <p>
                    In January 2005
                    <span class="em">1.2 million</span> children started grade one. Each of the circles below represents 1,000 learners that started grade one in 2005.</p>
            </div>

        </div>


        <div id="slide-three" class="slide">
            <div class="slide-inner">
                In 2005, <span class="em">1.2 million</span> children started Grade 1, the start of their school careers.
            </div>

        </div>

        <div id="slide-four" class="slide">

            <div class="slide-inner">
                Over the next seven years of primary school that number drops from 1.2 million to 910,994. That's
                <span class="em">297,002</span> few pupils in Grade Seven than started Grade One in 2005.
            </div>
        </div>


        <div id="slide-five" class="slide">
            <div class="slide-inner">
                From Grade 8 to 10 this trend reverses rapidly and by Grade 10 there are
                <span class="em">1,100,877</span> pupils. After Grade 10 the numbes decline rapidly. By Grade 12 there are just
                <span class="em">665,355</span> learners, just
                <span class="em">55%</span> of the number of learners that started Grade 1 12 years earlier.
            </div>
        </div>

        <div id="slide-six" class="slide">
            <div class="slide-inner">
                Slide 6: Comparing Grade 1 with Grade 12.
            </div>
        </div>



        <div id="slide-seven" class="slide">
            <div class="slide-inner">
                Slide 7: Pupils that passed matric.
            </div>
        </div>


        <div id="slide-eight" class="slide">
            <div class="slide-inner">
                Slide 8: Pupils with a university pass.
            </div>
        </div>






    </div>
    <!-- #SLIDES -->


    <div id="chart">



    </div>




    <script>

        // for reverse
        var startPositions = []; 
        var slide4reverse = false;
        var slide5reverse = false;

        //    $(window).on('beforeunload', function(){
        //      $(window).scrollTop(0);
        //    });

        $("document").ready(function () {
            // slide setup
            var slideWidth = $("#slides").width();
            var chartWidth = $("#chart").width();
            
            $(".slide").height(window.innerHeight);
            $("#slides").css("left", window.innerWidth / 2 - slideWidth / 2 + "px");
            $("#chart").css("left", (window.innerWidth / 2 - (chartWidth / 2)) + "px");
            $("#slides").css("opacity", 1);
            $("#chart").css("opacity", 1);

        });

        // config

        var width = 880,
            height = 480,
            padding = 20;

        var gradeBuckets = 2000,
            colCount = 0,
            rowCount = 0,
            colLimit = 12,
            xPos = 10,
            yPos = height - 30,
            radius = 2,
            spacing = 0.8,
            startXpos = xPos,
            labelXpos = startXpos,
            labels;









        d3.select("#chart")
            .style("width", width + padding * 2 + "px")
            .style("height", height + padding * 2 + "px")





        var svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + padding * 2)
            .attr("height", height + padding * 2)
            .append("g")
            .attr("transform", "translate(" + padding + " , " + padding + ")")


        var pos = $("svg").position();



        d3.csv("students.csv", function (data) {
            data.forEach(function (d) {
                d.pupils = +d.pupils / gradeBuckets;
            })




            addCircles(data[0].pupils, "grade1", "crimson", true);
            addCircles(data[0].pupils, "grade1ref", "black", true);


            for (var c = 1; c < 14; c++) {
                var i = c + 1;

                addCircles(data[c].pupils, "grade" + i, "#045a8d")

            }

            spreadCircles();

            var count = d3.selectAll(".grade2").size();
           





        })

        var slideTwoDone = false,
            slideThreeDone = false,
            slideFourDone = false,
            slideFiveDone = false,
            slideSixDone = false,
            slideSevenDone = false,
            slideEightDone = false;


        // waypoints
        $("document").ready(function () {



            var slide2 = new Waypoint({
                element: document.getElementById('slide-two'),
                handler: function (direction) {

                    if (direction === "down" && !slideTwoDone) {
                        slideTwoDone = true;
                        d3.selectAll(".grade1")
                            .transition()
                            .delay(function (d, i) {
                                return randomInt(100, 1000);
                            })
                            .style("opacity", 1)
                        //                slide_two(); 
                    }
                    else {
                        slideTwoDone = false;
                        d3.selectAll(".grade1")
                            .transition()
                            .delay(function (d, i) {
                                return randomInt(100, 1000);
                            })
                            .style("opacity", 0)

                    }
                },
                offset: window.innerHeight / 2
            })




            var slide3 = new Waypoint({
                element: document.getElementById("slide-three"),
                handler: function (direction) {

                    if (direction === "down" && !slideThreeDone) {
                        slideThreeDone = true;
                
                        slide_three();


                    }
                    else { 
                        slideThreeDone = false;
                        slide_three_reverse(); 
                    }

                }, offset: window.innerHeight / 2
            })



            var slide4 = new Waypoint({
                element: document.getElementById("slide-four"),
                handler: function (direction) {

                    if (direction === "down" && !slideFourDone) {
                        slideFourDone = true;
                        //                sticky3.destroy();
                        slide_four();

                    }
                    else { 
                        slideFourDone = false;
                        slide_four_reverse();
                    }

                }, offset: 200
            })


            var slide5 = new Waypoint({
                element: document.getElementById("slide-five"),
                handler: function (direction) {

                    if (direction === "down" && !slideFiveDone) {
                        slideFiveDone = true;
                        slide_five();
                    }
                    else { 
                        slideFiveDone = false; 
                        slide_five_reverse();
                    }

                }, offset: 200
            })


            var slide6 = new Waypoint({
                element: document.getElementById("slide-six"),
                handler: function (direction) {

                    if (direction === "down" && !slideSixDone) {
                        slideSixDone = true;
                        slide_six();
                    }
                    else { 
                        slideSixDone = false;
                        slide_six_reverse();
                    }

                }, offset: 200
            })



            var slide7 = new Waypoint({
                element: document.getElementById("slide-seven"),
                handler: function (direction) {

                    if (direction === "down" && !slideSevenDone) {
                        slideSevenDone = true;
                        slide_seven();
                    }
                    else { 
                        slideSevenDone = false; 
                        slide_seven_reverse();
                    }

                }, offset: 200
            })



            var slide8 = new Waypoint({
                element: document.getElementById("slide-eight"),
                handler: function (direction) {

                    if (direction === "down" && !slideEightDone) {
                        slideEightDone = true;
                        slide_eight();
                    }

                }, offset: 200
            })


        }); // document.ready







        // slide functions

        function slide_three() {
            svg.append("line")
                .attr("x1", 0)
                .attr("x2", width - 100)
                .attr("y1", height - 28)
                .attr("y2", height - 28)
                .style("stroke", "#fff")
                .style("stroke-width", 1)
                .style("opacity", 0)
                .transition()
                .duration(5000)
                .style("opacity", 0.7)

            makeBars(".bar1", ".grade1", "barNo1", "1,207,996", "Gr1 (2005)", ".label1", true);


        }

        function slide_three_reverse() {
            svg.selectAll("line")
                .transition()
                .duration(1000)
                .style("opacity", 0)

            svg.selectAll(".barLabels")
                .remove()
            svg.selectAll(".barNumbers")
                .remove();

            
                spreadCirclesReverse();
                svg.selectAll(".grade1")
                .style("opacity", 1)

            // makeBars(".bar1", ".grade1", "barNo1", "1,207,996", "Gr1 (2005)", ".label1", true);


        }


        function slide_four() {
            if(slide4reverse) { 
                svg.selectAll(".grade2group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade3group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade4group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade5group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade6group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade7group").transition().duration( 500 ).style("opacity", 1);
            }
            else { 
                makeBars("bar2", ".grade2", "barNo2", "1,056,241", "Gr2 (2006)", ".label2", false)
                makeBars("bar3", ".grade3", "barNo3", "1,040,022", "Gr3 (2007)", ".label3", false)
                makeBars("bar4", ".grade4", "barNo4", "1,023,963", "Gr4 (2008)", ".label4", false)
                makeBars("bar5", ".grade5", "barNo5", "980,945", "Gr5 (2009)", ".label5", false)
                makeBars("bar6", ".grade6", "barNo6", "948,213", "Gr6 (2010)", ".label6", false)
                makeBars("bar7", ".grade7", "barNo7", "910,994", "Gr7 (2011)", ".label3", false, true)
            }


        }

        function slide_four_reverse() { 
            
            svg.selectAll(".grade2group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade3group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade4group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade5group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade6group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade7group").transition().duration( 500 ).style("opacity", 0);
            

            slide4reverse = true; 
        }


        function slide_five() {
            if(slide5reverse) {
                svg.selectAll(".grade8group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade9group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade10group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade11group").transition().duration( 500 ).style("opacity", 1);
                svg.selectAll(".grade12group").transition().duration( 500 ).style("opacity", 1); 
            }
            else { 
                makeBars("bar8", ".grade8", "barNo8", "934,588", "Gr8 (2012)", ".label7", false)
                makeBars("bar9", ".grade9", "barNo9", "1,036,555", "Gr9 (2013)", ".label9", false)
                makeBars("bar10", ".grade10", "barNo10", "1,100,877", "Gr10 (2014)", ".label8", false)
                makeBars("bar11", ".grade11", "barNo11", "890,971", "Gr11 (2015)", ".label11", false)
                makeBars("bar12", ".grade12", "barNo2", "665,355", "Gr12 (2016)", ".label12", false, true)
                makeBars("bar13", ".grade13", "barNo13", "442,672", "", ".label13", false)
                makeBars("bar14", ".grade14", "barNo14", "162,374", "", ".label14", false)
            }

        }

        function slide_five_reverse() { 
            svg.selectAll(".grade8group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade9group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade10group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade11group").transition().duration( 500 ).style("opacity", 0);
            svg.selectAll(".grade12group").transition().duration( 500 ).style("opacity", 0);

            slide5reverse = true; 
        }



        function slide_six() {

            //        d3.select(".barNo14").style("opacity", 1)

            var origX12 = d3.select(".grade12").attr("cx");
            var xDiff = origX12 - width / 2 + 40;

            // clear intermediate bars
            for (var c = 2; c < 12; c++) {

                d3.selectAll(".grade" + c)
                    .transition()
                    .duration(1000)
                    .style("opacity", 0)
                    // .on("end", function () {
                    //     d3.select(this).remove();
                    // })


            }

            d3.selectAll(".grade1ref").transition().duration(1000).style("opacity", 0).on("end", function () { d3.select(this).remove(); })


            d3.selectAll(".barLabels").style("opacity", 0);
            d3.selectAll(".barNumbers")
                .classed("barremove", function (d, i) {
                    if (i > 0 && i < 11) {
                        return true;
                    }
                })

            d3.selectAll(".barremove").style("opacity", 0);

            // move grade 12 bar
            var labelX;
            d3.selectAll(".grade12")
                .each(function (d, i) {
                    var curX = d3.select(this).attr("cx");
                    d3.select(this).transition().delay(function (d, i) {
                        return randomInt(200, 1000);
                    })
                        .duration(200).attr("cx", curX - xDiff)

                })

            // move grade 12 labels
            d3.selectAll(".barNumbers")
                .classed("barNumbersTwo", function (d, i) {
                    if (i === 11) return true;
                    else return false;
                })
            d3.selectAll(".barNumbers")
                .classed("barNumbersOne", function (d, i) {
                    if (i === 0) return true;
                    else return false;
                })

            d3.select(".barNumbersOne").transition().duration(2000).attr("x", width / 2 - 60).style("text-anchor", "end")
            d3.select(".barNumbersTwo").transition().duration(2000).attr("x", width / 2 - 30).style("text-anchor", "start")
            //        
            //        

            //        moveBarNumber(".barNo12", xDiff);




            // move grade one to center
            //                startXpos + ((radius * 2 + spacing) * colLimit) / 2
            var startXpos = d3.select(".grade1").attr("cx");
            var xDiff = width / 2 - startXpos;



            var newStartX = newX = width / 2 - (radius * 2 + spacing) * (colLimit + 2) - 40, newY = height - 30, colCount = 0;
            d3.selectAll(".grade1")
                .each(function (d, i) {
                    d3.select(this).transition()
                        .delay(function () {

                            return randomInt(200, 1000);

                        })
                        .duration(1000).attr("cx", newX).attr("cy", newY)

                    newX = newX + spacing + radius * 2;
                    colCount++;

                    if (colCount === colLimit) {
                        newX = newStartX;
                        colCount = 0;
                        newY = newY - spacing - radius * 2;
                    }

                })



        }

        function slide_six_reverse() { 

            //move grade 1 to start
            var newX = 0; 
            var newStartX = newX;

            // var newStartX = newX = newX + (radius * 2 + spacing) * (colLimit + 2), 
            var newY = height - 30, colCount = 0;
            console.log(newX);

            d3.selectAll(".grade1")
                .each(function (d, i) {
                    d3.select(this).transition()
                        .delay(function () {

                            return randomInt(200, 1000);

                        })
                        .duration(1000).attr("cx", newX).attr("cy", newY)

                    newX = newX + spacing + radius * 2;
                    colCount++;

                    if (colCount === colLimit) {
                        newX = newStartX;
                        colCount = 0;
                        newY = newY - spacing - radius * 2;
                    }

                })

                var newStartX = newX = startPositions[10] + (radius * 2 + spacing) * (colLimit + 2);
                var newY = height - 30, colCount = 0;

                d3.selectAll(".grade12")
                .each(function (d, i) {
                    d3.select(this).transition()
                        .delay(function () {

                            return randomInt(200, 1000);

                        })
                        .duration(1000).attr("cx", newX).attr("cy", newY)

                    newX = newX + spacing + radius * 2;
                    colCount++;

                    if (colCount === colLimit) {
                        newX = newStartX;
                        colCount = 0;
                        newY = newY - spacing - radius * 2;
                    }

                })

            // move bar Numebrs
            d3.select(".barNumbersOne").transition().duration(2000).attr("x", ).style("text-anchor", "start")
            d3.select(".barNumbersTwo").transition().duration(2000).attr("x", startPositions[11]).style("text-anchor", "start")

            d3.selectAll(".barremove").style("opacity", 1);
            for(var x = 2; x < 12; x++) { 
                svg.selectAll(".grade" + x).transition().delay(500).duration(500).style("opacity",1);
            }

        }


        function slide_seven() {



            var getStartX = d3.select(".grade12").attr("cx");
            var curX = d3.select(".grade13").attr("cx");
            var startXdiff = curX - getStartX;
            var xDiff = curX - getStartX - (radius * 2 + spacing) * (colLimit + 2);
            var newLabelX = getStartX + (radius * 2 + spacing) * (colLimit + 2);



            d3.selectAll(".grade13")

                .each(function (d, i) {

                    var curX = d3.select(this).attr("cx");
                    d3.select(this).transition().duration(1000).style("opacity", 1).attr("cx", curX - xDiff)

                })



            moveBarNumber(".barNo13", xDiff);


        }

        function slide_seven_reverse() { 

            console.log("slide_seven_reverse");

            var curX = d3.select(".grade13").attr("cx");
            var endX = startPositions[12];
            var xDiff = endX - curX; 

            d3.selectAll(".grade13")
                .each( function (d, i) { 
                    var curX = +d3.select(this).attr("cx");
                    curX.toFixed(2);

                    d3.select(this).transition().duration(1000).style("opacity", 0).attr("cx", curX + xDiff)
                })

            // move bar number
            var textPos = endX + ((radius * 2 + spacing) * colLimit) / 2;
            d3.select(".barNo13")
                .transition(). duration(1000).attr("x", textPos).style("text-anchor", "middle").style("opacity", 0);


        }



        function slide_eight() {


            var getStartX = d3.select(".grade13").attr("cx");
            var curX = d3.select(".grade14").attr("cx");
            var xDiff = curX - getStartX - (radius * 2 + spacing) * (colLimit + 2);
            //get diff

            d3.selectAll(".grade14")

                .each(function (d, i) {

                    var curX = d3.select(this).attr("cx");
                    d3.select(this).transition().duration(1000).style("opacity", 1).attr("cx", curX - xDiff)

                })

            moveBarNumber(".barNo14", xDiff);


        }







        $(window).on('beforeunload', function(){
            $(window).scrollTop(0);
          });

        $("#link").click(function() {
            $('html, body').animate({
                scrollTop: $("#slide-two").offset().top
            }, 1000);
        });

        function noscroll() {
        // window.scrollTo( 0, 0 );
        }

        // add listener to disable scroll
        window.addEventListener('scroll', noscroll);

        // Remove listener to disable scroll
        // window.removeEventListener('scroll', noscroll);


    </script>



</body>

</html>